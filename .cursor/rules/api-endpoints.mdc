# API ç«¯ç‚¹è§„èŒƒ

## æ ¸å¿ƒ API ç«¯ç‚¹

### å¥åº·æ£€æŸ¥å’ŒçŠ¶æ€
- **GET /** - åŸºç¡€å¥åº·æ£€æŸ¥
  ```json
  Response: {"status": "ok", "message": "PolyAgent server is running."}
  ```

- **GET /config** - è·å–æœåŠ¡å™¨é…ç½®
  ```json
  Response: {
    "openai_api_configured": boolean,
    "iotex_rpc_url": string
  }
  ```

- **GET /agents/status** - æ£€æŸ¥ Agent è¿è¡ŒçŠ¶æ€
  ```json
  Response: {
    "market_monitor": "ok" | "error",
    "agent_manager": "ok" | "error"
  }
  ```

## AI Agent ç«¯ç‚¹

### å¸‚åœºç›‘æ§ Agent
- **POST /market-monitor**
  ```json
  Request: {"message": "ç”¨æˆ·æŸ¥è¯¢æ¶ˆæ¯"}
  Response: æµå¼æ–‡æœ¬å“åº”
  Content-Type: text/plain
  ```
  - åŠŸèƒ½ï¼šåŠ å¯†è´§å¸ä»·æ ¼æŸ¥è¯¢ã€å¸‚åœºåˆ†æã€æ–°é—»è·å–
  - ä½¿ç”¨ MarketMonitorAgent å¤„ç†è¯·æ±‚

### è·¨å¢ƒæ”¯ä»˜æ¡¥æ¥ Agent  
- **POST /market-trade**
  ```json
  Request: {"message": "ç”¨æˆ·æ“ä½œæ¶ˆæ¯"}
  Response: æµå¼æ–‡æœ¬å“åº”
  Content-Type: text/plain
  ```
  - åŠŸèƒ½ï¼šæ”¯ä»˜å®â†’ç¨³å®šå¸è½¬æ¢ã€åŒºå—é“¾æ“ä½œã€æœåŠ¡äº¤ä»˜
  - æ”¯æŒæ¶ˆæ¯è·¯ç”±ï¼šæ”¯ä»˜ã€æŸ¥è¯¢ã€è½¬è´¦ã€æ•…äº‹ã€æ€»ç»“

## åˆ†æ­¥æ”¯ä»˜æµç¨‹ç«¯ç‚¹

### æ­¥éª¤1ï¼šåˆ›å»ºæ”¯ä»˜è®¢å•
- **POST /payment/create**
  ```json
  Request: {}
  Response: æµå¼æ–‡æœ¬å“åº”
  ```
  - è°ƒç”¨æ”¯ä»˜å®æ²™ç›’ API åˆ›å»ºè®¢å•
  - è¿”å›æ”¯ä»˜é“¾æ¥å’Œè®¢å•ä¿¡æ¯

### æ­¥éª¤2ï¼šæŸ¥è¯¢æ”¯ä»˜çŠ¶æ€
- **POST /payment/query**
  ```json
  Request: {}
  Response: æµå¼æ–‡æœ¬å“åº”
  ```
  - æŸ¥è¯¢è®¢å•æ”¯ä»˜çŠ¶æ€
  - æ˜¾ç¤ºæµç¨‹è¿›åº¦

### æ­¥éª¤3ï¼šæŸ¥è¯¢ERC20æˆæƒé¢åº¦
- **POST /payment/allowance**
  ```json
  Request: {}
  Response: æµå¼æ–‡æœ¬å“åº”
  ```
  - æŸ¥è¯¢ä»£å¸æˆæƒé¢åº¦
  - ä½¿ç”¨ IoTeX Agent å¤„ç†

### æ­¥éª¤4ï¼šæˆæƒERC20ä»£å¸
- **POST /payment/approve**
  ```json
  Request: {}
  Response: æµå¼æ–‡æœ¬å“åº”
  ```
  - æ‰§è¡Œä»£å¸æˆæƒæ“ä½œ
  - æˆæƒ200ä¸ªä»£å¸ç»™æŒ‡å®šåœ°å€

### æ­¥éª¤5ï¼šæ‰§è¡Œç¨³å®šå¸è½¬è´¦
- **POST /payment/transfer**
  ```json
  Request: {}
  Response: æµå¼æ–‡æœ¬å“åº”
  ```
  - æ‰§è¡Œ5ä¸ªä»£å¸è½¬è´¦
  - è¿”å›äº¤æ˜“è¯¦æƒ…å’Œç¡®è®¤ä¿¡æ¯

### æ­¥éª¤6ï¼šæä¾›æ•…äº‹æœåŠ¡
- **POST /payment/story**
  ```json
  Request: {"story_demand": "æ•…äº‹éœ€æ±‚æè¿°"}
  Response: æµå¼æ–‡æœ¬å“åº”
  ```
  - ç”Ÿæˆå®šåˆ¶æ•…äº‹å†…å®¹
  - æ˜¾ç¤ºè®¢å•å®Œæˆæ‘˜è¦

## æ¼”ç¤ºå’Œæµ‹è¯•ç«¯ç‚¹

### è·å–æ¼”ç¤ºæµç¨‹
- **GET /demo/payment-flow**
  ```json
  Response: {
    "title": "ğŸŒ è·¨å¢ƒæ”¯ä»˜æ¡¥æ¥æ¼”ç¤ºæµç¨‹",
    "description": "æ¼”ç¤ºæµç¨‹æè¿°",
    "scenario": {...},
    "steps": [...]
  }
  ```

### å¿«é€Ÿæ¼”ç¤ºæ‰§è¡Œ
- **POST /demo/quick-test**
  ```json
  Request: {}
  Response: æµå¼æ–‡æœ¬å“åº”
  ```
  - è‡ªåŠ¨æ‰§è¡Œå®Œæ•´çš„6æ­¥æ”¯ä»˜æµç¨‹
  - ç”¨äºå¿«é€Ÿæ¼”ç¤ºå’Œæµ‹è¯•

## æµå¼å“åº”è§„èŒƒ

### å®ç°æœºåˆ¶
æ‰€æœ‰ AI Agent ç«¯ç‚¹éƒ½ä½¿ç”¨æµå¼å“åº”ï¼š
```python
def stream_agent_response():
    # ä½¿ç”¨é˜Ÿåˆ—æ•è· stdout
    # æ‰§è¡Œ Agent æ“ä½œ
    # é€å—è¿”å›å“åº”æ•°æ®
    yield f"{chunk}\n"
```

### å‰ç«¯å¤„ç†
```typescript
const reader = response.body.getReader();
const decoder = new TextDecoder();
while (true) {
    const { done, value } = await reader.read();
    if (done) break;
    const chunk = decoder.decode(value, { stream: !done });
    // æ›´æ–° UI
}
```

## é”™è¯¯å¤„ç†è§„èŒƒ

### æ ‡å‡†é”™è¯¯å“åº”
```json
{
  "error": "é”™è¯¯æè¿°ä¿¡æ¯"
}
HTTP Status: 400/500
```

### å¸¸è§é”™è¯¯ç 
- **400** - è¯·æ±‚å‚æ•°ç¼ºå¤±æˆ–æ— æ•ˆ
- **404** - ç«¯ç‚¹ä¸å­˜åœ¨ï¼ˆé€šå¸¸æ˜¯è·¯ç”±é…ç½®é—®é¢˜ï¼‰
- **500** - Agent åˆå§‹åŒ–å¤±è´¥æˆ–å†…éƒ¨é”™è¯¯

## é›†æˆæµ‹è¯•å»ºè®®

### ç«¯ç‚¹æµ‹è¯•è„šæœ¬
```python
import requests

def test_endpoints():
    base_url = "http://localhost:5000"
    
    # æµ‹è¯•å¥åº·æ£€æŸ¥
    response = requests.get(f"{base_url}/")
    assert response.status_code == 200
    
    # æµ‹è¯• AI Agent
    response = requests.post(f"{base_url}/market-trade", 
                           json={"message": "æµ‹è¯•æ¶ˆæ¯"})
    assert response.status_code == 200
```

### æµå¼å“åº”æµ‹è¯•
éªŒè¯æµå¼æ•°æ®çš„è¿ç»­æ€§å’Œå®Œæ•´æ€§ï¼Œç¡®ä¿å‰ç«¯èƒ½æ­£ç¡®è§£æå’Œæ˜¾ç¤ºå†…å®¹ã€‚
